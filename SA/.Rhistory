# transform Entr-Sor to Zone
trxZone <- trx %>% inner_join(ODtoGrid)
# find number of active day for each ID
t1 <- trxZone %>%
group_by(ID) %>%
summarise(ActiveDay = n_distinct(Date))
# find number of active day for each ID,Zone
t2 <- trxZone %>%
group_by(ID, Zone) %>%
summarise(Day = n_distinct(Date))
# get ID,Zone with (Zone frequently visited)
#   - ActiveDay >= limit.ActiveDay
#   - Per >= limit.ZonePer
trxZoneActive <- inner_join(t1,t2) %>%
mutate(Per = Day / ActiveDay) %>%
filter(ActiveDay >= limit.ActiveDay,
Per >= limit.ZonePer)
rm(t1,t2)
##########
### Step 4: find ID with only one big zone
##########
# get Grid detailed info for trxZoneActive
t <- inner_join(trxZoneActive, GridLimit)
# group them by ID
t <- t %>% group_by(ID)
# Get 4 points
#   NW  NE (NorthWest, NorthEast)
#   SW  SE (SouthWest, SouthEast)
t1 <- t %>% arrange(Row, Col)             %>% select(Row, Col) %>% slice(1) %>% rename(R_NW = Row, C_NW = Col)
t2 <- t %>% arrange(Row, desc(Col))       %>% select(Row, Col) %>% slice(1) %>% rename(R_NE = Row, C_NE = Col)
t3 <- t %>% arrange(desc(Row), Col)       %>% select(Row, Col) %>% slice(1) %>% rename(R_SW = Row, C_SW = Col)
t4 <- t %>% arrange(desc(Row), desc(Col)) %>% select(Row, Col) %>% slice(1) %>% rename(R_SE = Row, C_SE = Col)
temp <- inner_join(t1, t2) %>% inner_join(t3) %>% inner_join(t4)
rm(t1,t2,t3,t4)
# Compare to get One_Zone
#   C_NW & C_SW
#   C_NE & C_SE
temp <- temp %>% mutate(Left = (C_NW == C_SW),
Right = (C_NE == C_SE),
OneZone = Left && Right)
##########
### Step 5: get Hourheatmap for OneZone
##########
# get ID with only one zone
t <- temp %>%
filter(OneZone == TRUE) %>%
select(ID)
# get all grids for these ID
t <- inner_join(t,trxZoneActive) %>% select(ID,Zone) %>% ungroup %>% distinct
# Get all trx passing these grids for these ID
t <- inner_join(t,trxZone)
# transform back from Zone to Entr_Sor
t <- t %>% select(-Zone) %>% ungroup %>% distinct
# get time window
trxZoneActiveH <- t %>%
mutate(H = round(TimeSor, digits = 0),
H_2 = H - H %% 2
)
# get time window frequency >= limit.WindowFreq
result.ZW <- trxZoneActiveH %>%
group_by(ID,DOW,H) %>%
summarise(freq = n())
# %>%
#   filter(freq >= limit.WindowFreq)
rm(temp,ODtoGrid,GridLimit)
result.ZW
result.ZW %>% count(ID)
inputName <-  read.table(text = filename.Input, sep=".")$V1 %>% as.character
time <- Sys.time() %>% format(format = "%Y%m%d_%H%M")
write.table(result.TS,
paste0("Output/Algo_",inputName,"_V",time,".csv"),
sep=";",row.name=FALSE,quote=FALSE)
write.table(result.ZW, paste0("Output/Algo_",inputName,"_V",time,"_Window.csv"),sep=";",row.name=FALSE,quote=FALSE)
write.table(trxZoneActive, paste0("Output/Algo_",inputName,"_V",time,"_Zone.csv"),sep=";",row.name=FALSE,quote=FALSE)
rm(inputName,time)
source('~/GitHub/SA/Algo.R')
library(dplyr)
library(cluster)
rresult.TS
result.TS
result.ZW
gares
ref
GridLimit <- read.table("Reference/Ref_GridLimit.csv", header = T, sep = ";") %>% tbl_df
gares <- read.table("Reference/Ref_gares.csv", header = T, sep = ";") %>% tbl_df
ref <- read.table("Reference/Ref_VIPn.csv", header = T, sep = ";") %>%
tbl_df %>% mutate(ID = as.character(ID))
t <- left_join(result.TS, ref)
t
t1 <- result.TS %>% transmute(OD =as.character(OD))
t2 <- read.table(text = t1$OD,sep="-") %>% tbl_df %>%
transmute(Entr = V1, Sor = V2)
t1 <- cbind(result.TS,t2) %>% tbl_df
t1
t <- left_join(t1, ref)
t
gares
t1 <- gares %>% transmute(Entr = Cde, Elng = Lng, Elat = Lat)
t2 <- left_join(t,t1)
t2
t1 <- gares %>% transmute(Sor = Cde, Slng = Lng, Slat = Lat)
t2 <- left_join(t2,t1)
t2t2
t2
t2 <- t2 %>% mutate(
Elng = ifelse(Entr == 0, Slng, Elng),
Elat = ifelse(Entr == 0, Slat, Elat)
)
t2
t <- left_join(result.TS, ref)
t1 <- result.TS %>% transmute(OD =as.character(OD))
t2 <- read.table(text = t1$OD,sep="-") %>% tbl_df %>%
transmute(Entr = V1, Sor = V2)
t1 <- cbind(result.TS,t2) %>% tbl_df
t <- left_join(t1, ref)
t1 <- gares %>% transmute(Entr = Cde, Elng = Lng, Elat = Lat)
t2 <- left_join(t,t1)
t1 <- gares %>% transmute(Sor = Cde, Slng = Lng, Slat = Lat)
t2 <- left_join(t2,t1)
t <- t2 %>% mutate(
Elng = ifelse(Entr == 0, Slng, Elng),
Elat = ifelse(Entr == 0, Slat, Elat)
)
t
ggplot(t) +
geom_segment(aes(x=Elng,xend=Slng,
y=Elat,yend=Slat)
)
library(ggplot2)
ggplot(t) +
geom_segment(aes(x=Elng,xend=Slng,
y=Elat,yend=Slat)
)
ggplot(t) +
geom_segment(aes(x=Elng,xend=Slng,
y=Elat,yend=Slat)
) +
facet_wrap(~Nom)
t
result.TS
t$noPsg
ggplot(t) +
geom_segment(aes(x=Elng,xend=Slng,
y=Elat,yend=Slat, size = noPsg )
) +
facet_wrap(~Nom)
ggplot(t) +
geom_segment(aes(x=Elng,xend=Slng,
y=Elat,yend=Slat, alpha = noPsg )
) +
facet_wrap(~Nom)
t <- left_join(result.TS, ref)
t1 <- result.TS %>% transmute(OD =as.character(OD))
t2 <- read.table(text = t1$OD,sep="-") %>% tbl_df %>%
transmute(Entr = V1, Sor = V2)
t1 <- cbind(result.TS,t2) %>% tbl_df
t <- left_join(t1, ref)
t1 <- gares %>% transmute(Entr = Cde, Elng = Lng, Elat = Lat)
t2 <- left_join(t,t1)
t1 <- gares %>% transmute(Sor = Cde, Slng = Lng, Slat = Lat)
t2 <- left_join(t2,t1)
viz.TS <- t2 %>% mutate(
Elng = ifelse(Entr == 0, Slng, Elng),
Elat = ifelse(Entr == 0, Slat, Elat)
)
trxZoneActive
t <- left_join(trxZoneActive, ref)
t
t <- left_join(result.TS, ref)
t1 <- result.TS %>% transmute(OD =as.character(OD))
t2 <- read.table(text = t1$OD,sep="-") %>% tbl_df %>%
transmute(Entr = V1, Sor = V2)
t1 <- cbind(result.TS,t2) %>% tbl_df
t <- left_join(t1, ref)
t1 <- gares %>% transmute(Entr = Cde, Elng = Lng, Elat = Lat)
t2 <- left_join(t,t1)
t1 <- gares %>% transmute(Sor = Cde, Slng = Lng, Slat = Lat)
t2 <- left_join(t2,t1)
viz.TS <- t2 %>% mutate(
Elng = ifelse(Entr == 0, Slng, Elng),
Elat = ifelse(Entr == 0, Slat, Elat)
)
rm(t,t1,t2)
t <- left_join(trxZoneActive, ref)
t <- t %>% inner_join(GridLimit)
t
ggplot(t) +
geom_tile(aes(l,d, alpha = Per)) +
xlim(c(-2,8)) + ylim(c(42,49)) +
facet_wrap(~ID) +
geom_point(data= gares, aes(Lng, Lat, col = as.factor(Societe)))
ggplot(t) +
geom_tile(aes(l,d, alpha = Per))
ggplot(viz.ZW) +
geom_tile(aes(l,d, alpha = Per)) +
facet_wrap(~Nom)
viz.ZW <- t %>% inner_join(GridLimit)
ggplot(viz.ZW) +
geom_tile(aes(l,d, alpha = Per)) +
facet_wrap(~Nom)
ggplot() +
geom_segment(data = viz.TS,
aes(x=Elng,xend=Slng,
y=Elat,yend=Slat, alpha = noPsg )
) +
geom_tile(data = viz.ZW, aes(l,d, alpha = Per)) +
facet_wrap(~Nom)
gares
ggplot() +
geom_segment(data = viz.TS,
aes(x=Elng,xend=Slng,
y=Elat,yend=Slat, alpha = noPsg )
) +
geom_tile(data = viz.ZW, aes(l,d, alpha = Per)) +
facet_wrap(~Nom) +
geom_point(data= gares %>% filter(Societe != 5),
aes(Lng, Lat, col = as.factor(Societe)))
ggplot() +
geom_segment(data = viz.TS,
aes(x=Elng,xend=Slng,
y=Elat,yend=Slat, alpha = noPsg )
) +
geom_tile(data = viz.ZW, aes(l,d, alpha = Per)) +
facet_wrap(~Nom) +
geom_point(data= gares %>% filter(Societe != 5,
Lat < 45,
Lng >3),
aes(Lng, Lat, col = as.factor(Societe)))
ggplot() +
geom_segment(data = viz.TS,
aes(x=Elng,xend=Slng,
y=Elat,yend=Slat
)
) +
geom_tile(data = viz.ZW,
aes(l,d, alpha = Per)
) +
facet_wrap(~Nom) +
geom_point(data= gares %>% filter(Societe != 5,
Lat < 45,
Lng >3),
aes(Lng, Lat,
col = as.factor(Societe),
alpha = .1))
viz.TS %>% count(Nom)
viz.TS %>% filter(is.na(Nom))
t <- left_join(trxZoneActive, ref)
t %>% filter(is.na(Nom))
ggplot() +
geom_segment(data = viz.TS,
aes(x=Elng,xend=Slng,
y=Elat,yend=Slat
)
) +
geom_tile(data = viz.ZW,
aes(r,u, alpha = Per)
) +
facet_wrap(~Nom) +
geom_point(data= gares %>% filter(Societe != 5,
Lat < 45,
Lng >3),
aes(Lng, Lat,
col = as.factor(Societe),
alpha = .1))
ggplot() +
geom_segment(data = viz.TS,
aes(x=Elng,xend=Slng,
y=Elat,yend=Slat,
col = red
)
) +
geom_tile(data = viz.ZW,
aes(r,u, alpha = Per)
) +
facet_wrap(~Nom) +
geom_point(data= gares %>% filter(Societe != 5,
Lat < 45,
Lng >3),
aes(Lng, Lat,
col = as.factor(Societe),
alpha = .1))
ggplot() +
geom_segment(data = viz.TS,
aes(x=Elng,xend=Slng,
y=Elat,yend=Slat,
col = "red"
)
) +
geom_tile(data = viz.ZW,
aes(r,u, alpha = Per)
) +
facet_wrap(~Nom) +
geom_point(data= gares %>% filter(Societe != 5,
Lat < 45,
Lng >3),
aes(Lng, Lat,
col = as.factor(Societe),
alpha = .1))
ggplot() +
geom_segment(data = viz.TS,
aes(x=Elng,xend=Slng,
y=Elat,yend=Slat
),
colour = "red"
) +
geom_tile(data = viz.ZW,
aes(r,u, alpha = Per)
) +
facet_wrap(~Nom) +
geom_point(data= gares %>% filter(Societe != 5,
Lat < 45,
Lng >3),
aes(Lng, Lat,
col = as.factor(Societe),
alpha = .1))
ggplot() +
geom_segment(data = viz.TS,
aes(x=Elng,xend=Slng,
y=Elat,yend=Slat
),
colour = "red",
size = 2
) +
geom_tile(data = viz.ZW,
aes(r,u, alpha = Per)
) +
facet_wrap(~Nom) +
geom_point(data= gares %>% filter(Societe != 5,
Lat < 45,
Lng >3),
aes(Lng, Lat,
col = as.factor(Societe),
alpha = .1))
ggplot() +
geom_segment(data = viz.TS,
aes(x=Elng,xend=Slng,
y=Elat,yend=Slat
),
colour = "red",
size = 2
) +
geom_point(data = viz.TS %>% filter(Entr == 0),
aes(Slng,
Slat
),
colour = "red",
size = 2
) +
geom_tile(data = viz.ZW,
aes(r,u, alpha = Per)
) +
facet_wrap(~Nom) +
geom_point(data= gares %>% filter(Societe != 5,
Lat < 45,
Lng >3),
aes(Lng, Lat,
col = as.factor(Societe),
alpha = .1))
ggplot() +
geom_segment(data = viz.TS,
aes(x=Elng,xend=Slng,
y=Elat,yend=Slat
),
colour = "red",
size = 2
) +
geom_point(data = viz.TS %>% filter(Entr == 0),
aes(Slng,
Slat
),
colour = "red",
size = 2
) +
geom_tile(data = viz.ZW,
aes(l,d, alpha = Per)
) +
facet_wrap(~Nom) +
geom_point(data= gares %>% filter(Societe != 5,
Lat < 45,
Lng >3),
aes(Lng, Lat,
col = as.factor(Societe),
alpha = .1))
ggplot() +
geom_segment(data = viz.TS,
aes(x=Elng,xend=Slng,
y=Elat,yend=Slat
),
colour = "red",
size = 2
) +
geom_point(data = viz.TS %>% filter(Entr == 0),
aes(Slng,
Slat
),
colour = "red",
size = 2
) +
geom_tile(data = viz.ZW,
aes(r,u, alpha = Per)
) +
facet_wrap(~Nom) +
geom_point(data= gares %>% filter(Societe != 5,
Lat < 45,
Lng >3),
aes(Lng, Lat,
col = as.factor(Societe),
alpha = .1))
ggplot() +
geom_segment(data = viz.TS,
aes(x=Elng,xend=Slng,
y=Elat,yend=Slat
),
colour = "red",
size = 2
) +
geom_point(data = viz.TS %>% filter(Entr == 0),
aes(Slng,
Slat
),
colour = "red",
size = 3
) +
geom_tile(data = viz.ZW,
aes(r,u, alpha = Per)
) +
facet_wrap(~Nom) +
geom_point(data= gares %>% filter(Societe != 5,
Lat < 45,
Lng >3),
aes(Lng, Lat,
col = as.factor(Societe),
alpha = .1))
ggplot() +
geom_segment(data = viz.TS,
aes(x=Elng,xend=Slng,
y=Elat,yend=Slat
),
colour = "red",
size = 2
) +
geom_point(data = viz.TS %>% filter(Entr == 0),
aes(Slng,
Slat
),
colour = "red",
size = 3
) +
geom_tile(data = viz.ZW,
aes(r,l, alpha = Per)
) +
facet_wrap(~Nom) +
geom_point(data= gares %>% filter(Societe != 5,
Lat < 45,
Lng >3),
aes(Lng, Lat,
col = as.factor(Societe),
alpha = .2))
ggplot() +
geom_segment(data = viz.TS,
aes(x=Elng,xend=Slng,
y=Elat,yend=Slat
),
colour = "red",
size = 2
) +
geom_point(data = viz.TS %>% filter(Entr == 0),
aes(Slng,
Slat
),
colour = "red",
size = 3
) +
geom_tile(data = viz.ZW,
aes(r,d, alpha = Per)
) +
facet_wrap(~Nom) +
geom_point(data= gares %>% filter(Societe != 5,
Lat < 45,
Lng >3),
aes(Lng, Lat,
col = as.factor(Societe),
alpha = .2))
ggplot() +
geom_segment(data = viz.TS,
aes(x=Elng,xend=Slng,
y=Elat,yend=Slat
),
colour = "red",
size = 2
) +
geom_point(data = viz.TS %>% filter(Entr == 0),
aes(Slng,
Slat
),
colour = "red",
size = 3
) +
geom_tile(data = viz.ZW,
aes(r,u, alpha = Per)
) +
facet_wrap(~Nom) +
geom_point(data= gares %>% filter(Societe != 5,
Lat < 45,
Lng >3),
aes(Lng, Lat,
col = as.factor(Societe),
alpha = .2))
t <- left_join(trxZoneActiveH, ref)
t1 <- t %>% group_by(Nom,DOW,H) %>% summarise(freq = n())
ggplot(t1 %>% filter(ID %in% k)) + geom_tile(aes(DOW,H, fill = freq)) + facet_wrap(~Nom)
ggplot(t1) + geom_tile(aes(DOW,H, fill = freq)) + facet_wrap(~Nom)

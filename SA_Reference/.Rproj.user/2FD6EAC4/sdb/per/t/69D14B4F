{
    "contents" : "library(dplyr)\nlibrary(rmarkdown)\nlibrary(ggplot2)\nlibrary(gridExtra)\n\n##########\n### JF\n##########\nJF <- read.table(\"JF_2014-2015-2016.csv\", header = TRUE, sep = \",\") %>% tbl_df()\nJF <- JF %>% filter(Year > 2014) \nggplot(JF) + geom_bar(aes(DOW, fill = as.factor(JF)), binwidth=1) + xlim(c(0,7))\nggplot(JF) + geom_bar(aes(WOY, fill = as.factor(JF)), binwidth=1) + xlim(c(0,53))\nggplot(JF) + geom_tile(aes(Year*100+WOY, DOW, fill = as.factor(JF)))\n\nJF <- JF %>% select(Date,DOW, JF)\nJF$Date <- as.Date(as.character(JF$Date))\nsave(JF, file=\"JF.RData\")\n\n\n##########\n### Old\n# g1 <- read.table(\"Gares_1.csv\", header = T, sep = \";\", dec = \",\") %>% tbl_df()\n# names(g1) <- c(\"Ste\", \"Lib\", \"Autoroute\", \"Cde\", \"Sens\", \"PK\", \"Lat\", \"Lng\")\n# \n# g2 <- read.table(\"Gares_2.csv\", header = T, sep = \";\") %>% tbl_df()\n# names(g2) <- c(\"Cde\", \"Lib\")\n# g2 <- g2 %>% mutate(Ste = substr(Cde, 4,5))\n# \n# g3 <- read.table(\"Gares_Cofiroute.csv\", header = T, sep = \";\") %>% tbl_df()\n# names(g3) <- c(\"Ste\", \"Gare\", \"Autoroute\", \"Lib_complete\", \"PK\", \"INDBAR\", \"DATMES\", \"Cde\", \"Lib\", \"Lib_commercial\" )\n# \n# rm(g1, g2, g3)\n\n##########\n### LngLat\n##########\ngares.LngLat <- read.table(\"garesLngLat.csv\", header = T, sep = \",\") %>% tbl_df()\nnames(gares.LngLat)[1] <- \"Ste\"\n\nGetLngLat <- function(transaction) {\n  # Add longitude and lattitude to the transaction\n  # Args:\n  #\t  tansaction:\tEntr, Sor, ...\n  # Returns:\n  #\t  tansaction:\tEntr, Sor, ..., ELng, ELat, SLng, SLat\n  \n  ### !!! to be removed\n  #   transaction$Entr <- as.numeric(transaction$Entr)\n  #   transaction$Sor <- as.numeric(transaction$Sor)\n  cde <- gares.LngLat %>% transmute(Entr = Cde, ELng = Lng, ELat = Lat)\n  transaction <- left_join(transaction, cde, by = \"Entr\")\n  names(cde) <- c(\"Sor\", \"SLng\", \"SLat\")\n  transaction <- left_join(transaction, cde, by = \"Sor\")\n  return(transaction)\t\n}\n\n##########\n### ESCOTA - Ref sur les voies \n##########\nESCOTA.ref <- read.table(\"Gares_ESCOTA_ref.csv\", header = T, sep = \";\") %>% tbl_df()\nnames(ESCOTA.ref)[2] <- \"ES\"\n\nESCOTA.ref <- ESCOTA.ref %>% \n  filter(ES %in% c(\"E\", \"S\")) %>%\n  mutate(voie = as.numeric(as.character(voie))) %>%\n  filter(!is.na(voie))\n\nESCOTA.temp <- ESCOTA.ref %>% distinct(gare, ES) %>% transmute(gare, ES, Cde = 25006000 + gare)\n\n##########\n### ESCOTA - Ref sur Tarif\n##########\nESCOTA.SF <-  read.table(\"SF_2014.csv\", header = T,  sep = \";\", dec = \".\") %>% tbl_df()\ntSF.E <- ESCOTA.SF %>% distinct(Entr) %>% transmute(gare = Entr, Lib = Entree, ES = \"E\" , Cde = 25006000 + Entr) \ntSF.S <- ESCOTA.SF %>% distinct(Sor) %>% transmute(gare = Sor, Lib = Sortie, ES = \"S\" , Cde = 25006000 + Sor) \ntSF <- rbind(tSF.E, tSF.S)\n# ggplot(tSF) + geom_bar(aes(gare, fill = as.factor(ES)), binwidth = 1)\ntSF$Sys <- \"F\"\n\nESCOTA.SO <-  read.table(\"SO_2014.csv\", header = T,  sep = \";\", dec = \".\") %>% tbl_df()\ntSO <- ESCOTA.SO %>% transmute(gare = Cde, Lib, Cde = 25006000 + gare)\ntSO$ES <- \"O\"\ntSO$Sys <-\"O\"\n\ntTarif <- rbind(tSF, tSO)\ntemp <- tTarif %>% distinct(gare) %>% select(gare, Lib, Cde, Sys)\nESCOTA.temp <- left_join(ESCOTA.temp, temp) # get Sys\n\n# ggplot(t4) + geom_tile(aes(gare,ES, fill = ES)) + facet_wrap(~Sys, ncol = 1)\n\nESCOTA.temp$es <- 1\nESCOTA.temp$es[ESCOTA.temp$ES == \"S\"] <- 10\nESCOTA.temp <- ESCOTA.temp %>% group_by(Cde, gare, Lib, Sys) %>% summarise(es = sum(es))\n\nESCOTA.temp$ES <- \"ES\"\nESCOTA.temp$ES[ESCOTA.temp$es == 1] <- \"E\"\nESCOTA.temp$ES[ESCOTA.temp$es == 10] <- \"S\"\n\nrm(tSF, tSF.E, tSF.S, tSO, tTarif)\n\ntemp <- gares.LngLat %>% filter(Ste == 6) %>% select(Autoroute, Cde, PK, Lng, Lat) \nESCOTA.temp <- left_join(ESCOTA.temp, temp)\n\nESCOTA.temp <- ESCOTA.temp %>% ungroup() %>% select(-es)\n\n##########\n### gares.ESCOTA\n##########\nESCOTA <- ESCOTA.temp\nrm(ESCOTA.temp)\n\nggplot(ESCOTA,aes(Lng, Lat)) + geom_point(aes(col = as.factor(Sys)), size = 3, alpha = .5) +\n  geom_text(aes(label = gare), hjust=1, vjust=0)\n\n##########\n### get Sens\n##########\ntSF <- ESCOTA.SF %>% transmute(Entr = 25006000 + Entr,\n                         Sor = 25006000 + Sor,\n                         Entree, Sortie)  \ntSF <- GetLngLat(tSF)\n\nggplot(tSF) + \n  geom_segment(aes(x=ELng, xend = SLng, y = ELat, yend = SLat), alpha = .1) +\n  geom_point(data = gares.ESCOTA, aes(Lng, Lat, col = as.factor(Autoroute)), size = 3, alpha = .5)\n\nt <- tSF %>% select(Entr, Sor)\nt1 <- gares.ESCOTA %>% transmute(Entr = Cde, AE = Autoroute, PKE = PK)\nt <- left_join(t, t1)\nt1 <- gares.ESCOTA %>% transmute(Sor = Cde, AS = Autoroute, PKS = PK)\nt <- left_join(t, t1)\n\ntemp <- count(t, AE, AS)\n\nt$SensEntr <- 1\nt$SensSor <- 1\n\n# case 1: AE == AS\nt1 <- t %>% \n  filter(AE == AS) %>%\n  mutate(SensEntr = ifelse(PKE < PKS, 1, 2),\n         SensSor = SensEntr)\n\n# case 2: A52 - A57 \nt2 <- t %>%\n  filter( (AE == \"A52\" & AS == \"A57\") |\n          (AE == \"A57\" & AS == \"A52\") \n         ) %>%\n  mutate(SensEntr = ifelse(AE == \"A52\", 2, 1), \n         SensSor = SensEntr)\n\n# temp <- tTarif %>% distinct(gare)\n# names(temp)[2] <- \"Lib_Tarif\"\n# t1 <- gares.LngLat %>% filter(Societe == 6) %>% transmute(Cde, Lib)\n# temp1 <- full_join(t1, temp)\n# result: LngLat has 3 more gares \n# 22 ANTIBES PV NORD \n# 23 ANTIBES EST SORTIE\n# 80 LA BARQUE ENTREES\n\n# case 3 : A52 - A520\nt3 <- t %>%\n  filter(AE %in% c(\"A520\") |\n         AS %in% c(\"A520\")) %>%\n  mutate(SensEntr = 2, \n         SensSor = 1)\n\ntemp.sens <- rbind(t1,t2,t3)\n\n# case 4: A52 -> A8\nt1 <- t %>% \n  filter(AE ==\"A52\" & AS == \"A8\") %>%\n  mutate(SensEntr = 2,\n         SensSor = ifelse(PKS < 29, 2, 1))\n\n# case 5: A8 -> A52\nt2 <- t %>% \n  filter(AE ==\"A8\" & AS == \"A52\") %>%\n  mutate(SensSor = 1,\n         SensEntr = ifelse(PKE < 29, 1, 2))\n\n# case 6: A57 -> A8\nt3 <- t %>% \n  filter(AE ==\"A57\" & AS == \"A8\") %>%\n  mutate(SensEntr = 1,\n         SensSor = ifelse(PKS < 98, 2, 1))\n\n# case 5: A8 -> A57\nt4 <- t %>% \n  filter(AE ==\"A8\" & AS == \"A57\") %>%\n  mutate(SensSor = 2,\n         SensEntr = ifelse(PKE < 98, 1, 2))\n\n##########\n### SF\ntemp.sens <- rbind(temp.sens,t1,t2,t3,t4)\nESCOTA.sens.SF <- temp.sens\nrm(t, tSF, t1,t2,t3,t4,temp.sens, temp)\n\n##########\n### SO\ntSO <- ESCOTA.SO %>% transmute(gare = Cde, Lib) \ntSO <- left_join(tSO, ESCOTA %>% select(Cde, gare, Autoroute))\n\nt <- ESCOTA.ref %>% \n  select(gare, ES, voie)\n\ntSO <- left_join(tSO, t)\n\n\n# case 1:\n# Canet de mereuil, Antibes ouest,  Saint Isidore Ech Ouest, La Turibe Ech Est\n# Ceux dont les voies >= 20 sont en sens 1\nt1 <- tSO %>%\n  filter(gare %in% c(1,14,19,26)) %>%\n  mutate(Sens = ifelse(voie >=20, 1, 2))\n\n# case 2:\n# FrÃ©jus, Les Adrets, Antibes PV, Antibes Est, Cagnes Est, Saint Isidore ech Est, Saint Isidore PV, La Turbie PV\n# Ceux dont les voies >= 20 sont en sens 2\nt2 <- tSO %>%\n  filter(gare %in% c(10,11,12,13,16,20,21,27)) %>%\n  mutate(Sens = ifelse(voie >=20, 2, 1))\n\n# case 3:\n# 17,24: Sens = 1\n# 15: Sens = 2\nt3 <- tSO%>%\n  filter(gare %in% c(15,17,24)) %>%\n  mutate(Sens = ifelse(gare == 15, 2, 1))\n\n# case4:\n# not in A8\nt4 <- tSO%>%\n  filter(Autoroute != \"A8\") %>%\n  mutate(Sens = 0)\n\nESCOTA.sens.SO <- rbind(t1,t2,t3,t4)\nrm(t,t1,t2,t3,t4, tSO)\n\n##########\n### ESCOTA.sens\nt1 <- ESCOTA.sens.SF %>%\n  select(Entr, Sor, SensEntr, SensSor) %>%\n  mutate(Voie = 0)\n\nt2 <- ESCOTA.sens.SO %>% \n  transmute (Entr = 0, Sor = Cde, Voie = voie, SensEntr = 0, SensSor = Sens)\n\nESCOTA.sens <- rbind(t1,t2)\nrm(t1,t2)\n         \n##########\n### ASF.sens\ntemp <- read.table(\"export_trjtsns_asf.csv\", sep = \";\", header = TRUE) %>% tbl_df()\nnames(temp) <- c(\"E1\",\"E2\",\"E3\",\"EA\",\"SensEntr\",\n                 \"S1\",\"S2\",\"S3\",\"SA\",\"SensSor\")\ntemp <- temp %>% \n  transmute(Entr = E1 * 100000 + E2 * 1000 + as.numeric(as.character(E3)), \n            SensEntr, SteEntr = E2,\n            Sor = S1 * 100000 + S2 * 1000 + as.numeric(as.character(S3)), \n            SensSor, SteSor = S2) %>%\n  filter(!is.na(Entr) & !is.na(Sor))\n\ntemp %>% group_by(SteEntr) %>% summarise(n = n_distinct(Entr))\ntemp %>% group_by(SteSor) %>% summarise(n = n_distinct(Sor))\n\nASF.sens <- temp\nrm(temp)\n\nASF.sens <- ASF.sens %>%\n  transmute(Entr, Sor, SensEntr, SensSor, Voie = 0)\nrm(temp)\n\n##########\n### sens\nsens <- rbind(ASF.sens, ESCOTA.sens)\nsave(sens, file=\"Sens_ref.RData\")\nwrite.table(sens,\"Ref_sens.csv\",sep=\";\",row.name=FALSE,quote=FALSE)\nwrite.table(JF,\"Ref_JF.csv\",sep=\";\",row.name=FALSE,quote=FALSE)\n",
    "created" : 1442932553482.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "4267025205",
    "id" : "69D14B4F",
    "lastKnownWriteTime" : 1443637679,
    "path" : "~/GitHub/SA_Reference/Reference.R",
    "project_path" : "Reference.R",
    "properties" : {
        "tempName" : "Untitled1"
    },
    "relative_order" : 1,
    "source_on_save" : false,
    "type" : "r_source"
}